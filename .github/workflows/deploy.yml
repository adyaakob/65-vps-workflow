name: Deploy to Dokploy VPS

on:
  push:
    branches: [master]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
    
    - name: Debug SSH Connection
      run: |
        echo "Debugging SSH connection..."
        ssh -vv -o StrictHostKeyChecking=no root@167.235.75.153 "echo 'SSH connection successful'"
      continue-on-error: true
    
    - name: Prepare Deployment
      run: |
        echo "Starting deployment to VPS"
        mkdir -p ~/.ssh
        ssh-keyscan -H 167.235.75.153 >> ~/.ssh/known_hosts
    
    - name: Deploy to VPS
      run: |
        echo "Attempting deployment..."
        ssh -o StrictHostKeyChecking=no root@167.235.75.153 "mkdir -p /var/www/html/dahalan.org/testworkflow/"
        scp -o StrictHostKeyChecking=no -r src/* root@167.235.75.153:/var/www/html/dahalan.org/testworkflow/
        echo "Deployment files transferred successfully"
      
    - name: Verify Deployment
      run: |
        echo "Verifying deployment..."
        response=$(curl -s -w "%{http_code}" https://dahalan.org/testworkflow/index.html)
        if [ "$response" -eq 200 ]; then
          echo "Deployment successful! Website is live."
        else
          echo "Deployment verification failed. HTTP status: $response"
          exit 1
        fi
